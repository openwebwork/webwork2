// This is the View for the dialog for addings students manually    

define(['Backbone', 'underscore','models/User','models/UserList','config','stickit'], 
	function(Backbone, _, User, UserList, config){	
	var AddStudentManView = Backbone.View.extend({
		id: "addStudManDialog",	    
		initialize: function(options){
		    var self=this;
		    _.bindAll(this, 'render','importStudents','addStudent','openDialog','closeDialog'); // every function that uses 'this' as the current object should be in here
		    this.collection = new UserList([new User()]);  // add a single blank user to the collection of students to import.		    		    

		    this.rowTemplate = $("#user-row-template").html();
		    this.collection.bind('add', this.render);
		    this.courseUsers = options.users; 
		    this.render();
		    
		    this.$el.dialog({autoOpen: false, modal: true, title: "Add Students by Hand",
							width: (0.95*window.innerWidth), height: (0.60*window.innerHeight) });
		    		    
	     	Backbone.Validation.bind(this);
		},
		events: {
		    "click button#import-stud-button": "importStudents",
		    "click button#add-more-button": "addStudent",
		    "click button#cancel-import": "closeDialog"
		},
		openDialog: function () { 
			this.$el.dialog("open");
			this.collection = new UserList([new User()]);
			this.render();
		},
		closeDialog: function () {this.$el.dialog("close");},
		template: _.template($("#add_student_man_dialog_content").html()),
		render: function(){
			var self = this;
		    this.$el.html($("#manual-import-template").html());
		    var table = this.$("table#man_student_table tbody");
		    this.tableRows = []; 
		    this.collection.each(function(user){ 
		    	var tableRow = new UserRowView({model: user, rowTemplate: self.rowTemplate});
			    table.append(tableRow.render().el);
			    self.tableRows.push(tableRow);
		    });
		    
			    
		    //this.errorPane = new Closeable({el: this.$("#error-pane-add-man"), classes : ["alert-error"]});
		    
		    
		    
		},
		importStudents: function(){  // validate each student data then if successful upload to the server.
		    var self = this;
		    var usersValid = _(this.tableRows).map(function(row){ return row.isValid();});
		    
		    console.log(usersValid);
		    
		    if (_.all(usersValid, _.identity)) { 
		    	this.closeDialog();
		    	this.collection.each(function(_user) {
		    		self.courseUsers.add(_user);
		    	});
			}
		},
		addStudent: function (){ 
			this.collection.add(new User());
		}
    });

	var UserRowView = Backbone.View.extend({
        tagName: "tr",
        initialize: function (options) {
            _.bindAll(this,'render','isValid');
        	this.invBindings = _.extend(_.invert(_.omit(this.bindings,".permission")),
        		{"user_id": ".login-name", "email_address": ".email"});
		    this.rowTemplate = options.rowTemplate;
		    this.permissions = config.permissions;
		
        },
        render: function () {
            this.$el.html(this.rowTemplate);
            this.stickit();
            return this; 
	    },       
    	bindings : { ".student-id": "student_id",
    				".last-name": {
    					observe: "last_name",
    				},
    				".first-name": "first_name",
    				".status": "status",
    				".comment": "comment",
    				".status": "status",
    				".recitation": "recitation",
    				".email": {observe: "email_address", setOptions: {silent:true}},
    				".login-name": {observe: "user_id", setOptions: {silent:true}},
    				".password": "password",
    				".permission": { 
    					observe: "permission",
    					selectOptions: { collection: "this.permissions",
    								labelPath: "label", valuePath: "value"}
    				}
    			},
        events: {
		    'click delete-button': 'removeRow'
		},
		isValid: function() { // checks if the user data is valid and shows error messages. 
			var self = this; 
	    	var errors = this.model.validate();
	    	console.log(this.model);
	    	console.log(errors);

        	if(errors){
                _(errors).chain().keys().each(function(attr){
                    self.$(self.invBindings[attr]).popover({placement: "top", content: errors[attr]})
                    	.popover("show").addClass("error");
        	    });
            }
            return errors === undefined; 

		},
		removeRow: function () { 
			console.log("in removeRow");
			this.model.collection.remove(this.model,{silent: true}); 
			this.$el.remove();	
		}

    });


    return AddStudentManView;

});
    