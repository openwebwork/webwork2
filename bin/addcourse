#!/usr/bin/env perl
################################################################################
# WeBWorK Online Homework Delivery System
# Copyright © 2000-2003 The WeBWorK Project, http://openwebwork.sf.net/
# $CVSHeader: webwork2/bin/addcourse,v 1.13 2004/05/22 01:08:08 sh002i Exp $
# 
# This program is free software; you can redistribute it and/or modify it under
# the terms of either: (a) the GNU General Public License as published by the
# Free Software Foundation; either version 2, or (at your option) any later
# version, or (b) the "Artistic License" which comes with this package.
# 
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the
# Artistic License for more details.
################################################################################

=head1 NAME

addcourse - add a course

=head1 SYNOPSIS

 addcourse [options] COURSEID

=head1 DESCRIPTION

Add a course to the courses directory. The required directories will be created.
Optionally, a database can be populated with users. Also, one or more users can
be granted professor privileges.

=head1 OPTIONS

=over

=item B<--db-layout>=I<LAYOUT>

The specified database layout will be used in place of the default specified in
F<global.conf>.

If B<--db-layout> is set to C<gdbm>, the following options are valid:

=over

=item B<--global-user>=I<USERID>

Specifies that the user ID of the global user will be I<USERID>, overriding the
value set in F<database.conf>. Applicable only to courses using the C<gdbm>
database layout.

=back

If B<--db-layout> is set to C<sql>, the following options are valid:

=over

=item B<--sql-host>=I<HOST>

Specifies the hostname of the SQL server on which to create the course database.
If not specified, the default for your RDBMS will be used.

=item B<--sql-port>=I<PORT>

Specifies the port of the SQL server on which to create the course database. If
not specified, the default for your RDBMS will be used.

=item B<--sql-user>=I<USER>

Specifies the username to use when connecting to the SQL server to create the
course database. This user must have CREATE, DELETE, FILE, INSERT, SELECT, and
UPDATE privileges, WITH GRANT OPTION.

=item B<--sql-pass>=I<PASS>

Specifies the password to use when connecting to the SQL server.

=item B<--sql-db>=I<DBNAME>

Specifies the name of the database to create. (This is usually
"webwork_COURSENAME", but can be overridden by changing the database layout in
F<global.conf>.)

=item B<--sql-wwhost>=I<WWHOST>

Specifies the host from which the webwork database users will be allowed to
connect. (if B<--sql-host> is set to localhost, this should be set to localhost
too.)

=back

=item B<--users>=I<FILE>

The users listed in the comma-separated text file I<FILE> will be added to the
user list of the new course. The format of this file is the same as user lists
exported from WeBWorK.

=item B<--professors>=I<USERID>[,I<USERID>]...

Each I<USERID>, if it is present in the new course's user list, will be granted
professor privileges (i.e. a permission level of 10). Requires B<--users>.

=item B<--templates-from>=I<COURSEID>

If specified, the contents of the specified course's templates directory are
used to populate the new course's templates directory.

=item I<COURSEID>

The name of the course to create.

=back

=cut

BEGIN {
	# hide arguments (there could be passwords there!)
	$0 = "$0";
}

use strict;
use warnings;
use Getopt::Long;

BEGIN {
	die "WEBWORK_ROOT not found in environment.\n"
		unless exists $ENV{WEBWORK_ROOT};
}

use lib "$ENV{WEBWORK_ROOT}/lib";
use WeBWorK::CourseEnvironment;
use WeBWorK::DB;
use WeBWorK::Utils qw(runtime_use readFile cryptPassword);
use WeBWorK::Utils::CourseManagement qw(addCourse deleteCourse listCourses);

sub usage {
	print STDERR "usage: $0 [options] COURSEID\n";
	print STDERR "Options:\n";
	print STDERR "  [--db-layout=LAYOUT]\n";
	print STDERR "  for \"sql\" database layout:\n";
	print STDERR "    [--sql-host=HOST] [--sql-port=port]\n";
	print STDERR "    --sql-user=USER --sql-pass=PASS\n";
	print STDERR "    --sql-db=DBNAME --sql-wwhost=WWHOST\n";
	print STDERR "  for \"gdbm\" database layout:\n";
	print STDERR "    [--global-user=USERID]\n";
	print STDERR "  [--users=FILE [--professors=USERID[,USERID]...] ]\n";
	exit;
}

sub usage_error {
	print STDERR "$0: @_\n";
	usage();
}

my $dbLayout = "";
my $sql_host = "";
my $sql_port = "";
my $sql_user = "";
my $sql_pass = "";
my $sql_db = "";
my $sql_wwhost = "";
my $globalUserID = "";
my $users = "";
my @professors = ();
my $templates_from = "";

##### get command-line options #####

GetOptions(
	"db-layout=s" => \$dbLayout,
	"sql-host=s" => \$sql_host,
	"sql-port=s" => \$sql_port,
	"sql-user=s" => \$sql_user,
	"sql-pass=s" => \$sql_pass,
	"sql-db=s" => \$sql_db,
	"sql-wwhost=s" => \$sql_wwhost,
	"global-user=s" => \$globalUserID,
	"users=s" => \$users,
	"professors=s" => \@professors,
	"templates-from=s" => \$templates_from,
);
my %professors = map { $_ => 1 } map { split /,/ } @professors;
my $courseID = shift;

##### perform sanity checks #####

usage_error("must specify COURSEID.") unless $courseID;

# bring up a minimal course environment
my $ce = WeBWorK::CourseEnvironment->new({
	webwork_dir => $ENV{WEBWORK_ROOT},
	courseName => $courseID
});

if ($dbLayout) {
	die "Database layout $dbLayout does not exist in the course environment.",
			" (It must be defined in global.conf.)\n"
		unless exists $ce->{dbLayouts}->{$dbLayout};
} else {
	# use default value
	$dbLayout = $ce->{dbLayoutName};
}

if ($dbLayout eq "sql") {
	usage_error("must specify --sql-user.")   unless $sql_user;
	usage_error("must specify --sql-pass.")   unless $sql_pass;
	usage_error("must specify --sql-db.")     unless $sql_db;
	usage_error("must specify --sql-wwhost.") unless $sql_wwhost;
} elsif ($dbLayout eq "gdbm") {
	# no required params, apparently...
}

usage_error("can't specify --professors without also specifying --users.")
	if @professors and not $users;

##### set up parameters to pass to addCourse() #####

my %courseOptions = ( dbLayoutName => $dbLayout );
if ($dbLayout eq "gdbm") {
	$courseOptions{globalUserID} = $globalUserID if $globalUserID ne "";
}

my %dbOptions;
if ($dbLayout eq "sql") {
	$dbOptions{host}     = $sql_host if $sql_host ne "";
	$dbOptions{port}     = $sql_port if $sql_port ne "";
	$dbOptions{username} = $sql_user;
	$dbOptions{password} = $sql_pass;
	$dbOptions{database} = $sql_db;
	$dbOptions{wwhost}   = $sql_wwhost;
}

my @users;
if ($users) {
	# this is a hack to create records without bringing up a DB object
	#my $db = WeBWorK::DB->new($ce->{dbLayouts}->{$dbLayout});
	my $userClass = $ce->{dbLayouts}->{$dbLayout}->{user}->{record};
	my $passwordClass = $ce->{dbLayouts}->{$dbLayout}->{password}->{record};
	my $permissionClass = $ce->{dbLayouts}->{$dbLayout}->{permission}->{record};
	
	runtime_use($userClass);
	runtime_use($passwordClass);
	runtime_use($permissionClass);
	
	my @contents = split /\n/, readFile($users);
	
	# much of this code is burgled from UserList.pm
	foreach my $string (@contents) {
		$string =~ s/^\s+//;
		$string =~ s/\s+$//;
		my (
			$student_id, $last_name, $first_name, $status, $comment,
			$section, $recitation, $email_address, $user_id
		) = split /\s*,\s*/, $string;
		
		my $User = $userClass->new();
		$User->user_id($user_id);
		$User->first_name($first_name);
		$User->last_name($last_name);
		$User->email_address($email_address);
		$User->student_id($student_id);
		$User->status($status);
		$User->section($section);
		$User->recitation($recitation);
		$User->comment($comment);
		
		my $Password = $passwordClass->new;
		$Password->user_id($user_id);
		$Password->password(cryptPassword($student_id));
		
		my $PermissionLevel = $permissionClass->new;
		$PermissionLevel->user_id($user_id);
		if (exists $professors{$user_id}) {
			$PermissionLevel->permission(10);
			delete $professors{$user_id};
		} else {
			$PermissionLevel->permission(0);
		}
		
		push @users, [ $User, $Password, $PermissionLevel ];
	}
	
	if (my @ids = keys %professors) {
		print STDERR "warning: @ids not in imported user list.\n";
	}
}

my %optional_arguments;
if ($templates_from ne "") {
	$optional_arguments{templatesFrom} = $templates_from;
}

##### call addCourse(), handle errors #####

eval {
	addCourse(
		courseID      => $courseID,
		ce            => $ce,
		courseOptions => \%courseOptions,
		dbOptions     => \%dbOptions,
		users         => \@users,
		%optional_arguments,
	);
};

if ($@) {
	my $error = $@;
	print STDERR "$error\n";
	exit;
}

__END__

if ($templates) {
	unless (-d "$courseDir/templates") {
		warn "$courseDir/templates: not found, creating:\n";
		print "mkdir $courseDir/templates\n";
		mkdir "$courseDir/templates"
			or die "Failed to mkdir $courseDir/templates: $!\n";
	}
	print "copy $templates/* -> $courseDir/templates\n";
	system "/bin/cp -r $templates/* $courseDir/templates/"
		and die "Failed to copy $templates/* to $courseDir/templates: $!\n";
}

if ($users) {
	# import users - much of this code is burgled from UserList.pm
	
	my $db;
	if ($dbLayout) {
		# use the specified layout
		$db = WeBWorK::DB->new($ce->{dbLayouts}->{$dbLayout});
	} else {
		# use the default layout
		$db = WeBWorK::DB->new($ce->{dbLayout});
	}
	
	my @contents = split /\n/, readFile($users);
	
	my $globalUserPresent = 0;
	
	foreach my $string (@contents) {
		$string =~ s/^\s+//;
		$string =~ s/\s+$//;
		my (
			$student_id, $last_name, $first_name, $status, $comment,
			$section, $recitation, $email_address, $user_id
		) = split /\s*,\s*/, $string;
		
		my $User = $db->newUser;
		$User->user_id($user_id);
		$User->first_name($first_name);
		$User->last_name($last_name);
		$User->email_address($email_address);
		$User->student_id($student_id);
		$User->status($status);
		$User->section($section);
		$User->recitation($recitation);
		$User->comment($comment);
		
		my $PermissionLevel = $db->newPermissionLevel;
		$PermissionLevel->user_id($user_id);
		if (exists $professors{$user_id}) {
			$PermissionLevel->permission(10);
		} else {
			$PermissionLevel->permission(0);
		}
		
		my $Password = $db->newPassword;
		$Password->user_id($user_id);
		$Password->password(cryptPassword($student_id));
		
		$db->addUser($User);
		$db->addPermissionLevel($PermissionLevel);
		$db->addPassword($Password);
		
		if ($user_id eq $globalUserID) {
			$globalUserPresent = 1;
		}
		
		if (exists $professors{$user_id}) {
			print "add professor $user_id\n";
			delete $professors{$user_id};
		} else {
			print "add user $user_id\n";
		}
	}
	
	if (my @ids = keys %professors) {
		print STDERR "warning: @ids not in imported user list.\n";
	}
	
	unless ($globalUserPresent) {
		warn "warning: global user $globalUserID not in imported user list.\n",
		     "         please add a user with this user ID manually.\n";
	}
}

my $courseEnvFile = $ce->{courseFiles}->{environment};
print "writing $courseEnvFile... ";
open my $fh, ">", $courseEnvFile
	or die "failed to open $courseEnvFile for writing.\n";

print $fh <<EOF;
#!perl
################################################################################
# WeBWorK Online Homework Delivery System
# Copyright © 2000-2003 The WeBWorK Project, http://openwebwork.sf.net/
# 
# This program is free software; you can redistribute it and/or modify it under
# the terms of either: (a) the GNU General Public License as published by the
# Free Software Foundation; either version 2, or (at your option) any later
# version, or (b) the "Artistic License" which comes with this package.
# 
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the
# Artistic License for more details.
################################################################################

# This file is used to override the global WeBWorK course environment for
# requests to this course. All package variables set in this file are added to
# the course environment. If you wish to set a variable here but omit it from
# the course environment,  use the "my" keyword. Commonly changed configuration
# options are noted below. The commented-out values are the values which were
# set in the global configuration file at the time this course was created.

EOF

print $fh <<EOF;
# Database layout -- if this course uses a different database layout than the
# one defined in the global configuration file, set it here.
# 
# Example: \$dbLayoutName = "sql";
#          \*dbLayout = \$dbLayouts{sql};
# 
EOF

if ($dbLayout) {
	print $fh "\$dbLayoutName = '$dbLayout';\n";
	print $fh "\*dbLayout = \$dbLayouts{$dbLayout};\n";
} else {
	my $defaultLayoutName = $ce->{dbLayoutName};
	if ($defaultLayoutName) {
		print $fh "#\$dbLayoutName = '$defaultLayoutName';\n";
		print $fh "#\*dbLayout = \$dbLayouts{\$dbLayoutName};\n";
	} else {
		print $fh "#\$dbLayoutName = '#NOT#FOUND#';\n";
		print $fh "#\*dbLayout = \$dbLayouts#NOT#FOUND#;\n";
		warn "default database layout name (\$dbLayoutName) not found in course environment.\n";
	}
}

print $fh <<EOF;

# Global user ID - denotes the ID of the user that the GlobalTableEmulator will
# use to store data for the set and problem tables. only applicable when using
# the GDBM database layout.
# 
# Example: \$dbLayouts{gdbm}->{set}->{params}->{globalUserID} = 'some_user';
#          \$dbLayouts{gdbm}->{problem}->{params}->{globalUserID} = 'some_user';
# 
EOF

if ($globalUserID) {
	print $fh "\$dbLayouts{gdbm}->{set}->{params}->{globalUserID} = '$globalUserID';\n";
	print $fh "\$dbLayouts{gdbm}->{problem}->{params}->{globalUserID} = '$globalUserID';\n";
} else {
	my $defaultGlobalUserID = $ce->{dbLayouts}->{gdbm}->{set}->{params}->{globalUserID};
	if (defined $defaultGlobalUserID) {
		print $fh "#\$dbLayouts{gdbm}->{set}->{params}->{globalUserID} = '$defaultGlobalUserID';\n";
		print $fh "#\$dbLayouts{gdbm}->{problem}->{params}->{globalUserID} = '$defaultGlobalUserID';\n";
	} else {
		print $fh "#\$dbLayouts{gdbm}->{set}->{params}->{globalUserID} = '#NOT#FOUND#';\n";
		print $fh "#\$dbLayouts{gdbm}->{problem}->{params}->{globalUserID} = '#NOT#FOUND#';\n";
		warn "default GDBM global user ID not found in course environment.\n";
	}
}

print $fh <<EOF;

# Allowed mail recipients - list of email addresses that the PG system is
# allowed to send mail to. (This prevents subtle PG exploits.) If this is not
# set somewhere, mail from the PG system (i.e. questionaires, essay questions)
# will fail.
# 
# Example: \$mail{allowedRecipients} = [ 'gage\@math.rochester.edu', 'apizer\@math.rochester.edu' ];
# 
EOF

if (defined $ce->{mail}->{allowedRecipients}) {
	my $value = join ", ", map { "'$_'" } @{ $ce->{mail}->{allowedRecipients} };
	print $fh "#\$mail{allowedRecipients} = [ $value ];\n";
} else {
	print $fh "#\$mail{allowedRecipients} = [  ];\n";
}

print $fh <<EOF;

# Feedback recipients - list of email addresses to send feedback to. If not
# defined, mail is sent to all professors and TAs.
# 
# Example: \$mail{feedbackRecipients} = [ 'gage\@math.rochester.edu', 'apizer\@math.rochester.edu', 'feedback-list\@lists.webwork.rochester.edu' ];
# 
EOF

if (defined $ce->{mail}->{feedbackRecipients}) {
	my $value = join ", ", map { "'$_'" } @{ $ce->{mail}->{feedbackRecipients} };
	print $fh "#\$mail{feedbackRecipients} = [ $value ];\n";
} else {
	print $fh "#\$mail{feedbackRecipients} = [  ];\n";
}

print $fh <<EOF;

# Special PG environment variable: PRINT_FILE_NAMES_FOR -  List the user IDs of
# users who should get PG source file names in their rendered problems. This is
# usually set to the list of professors and TAs in the course.
# 
# Example: \$pg{specialPGEnvironmentVars}->{PRINT_FILE_NAMES_FOR}  = [ 'gage', 'apizer', 'voloshin' ];
# 
EOF

if (defined $ce->{pg}->{specialPGEnvironmentVars}->{PRINT_FILE_NAMES_FOR}) {
	my $value = join ", ", map { "'$_'" }
		@{ $ce->{pg}->{specialPGEnvironmentVars}->{PRINT_FILE_NAMES_FOR} };
	print $fh "#\$pg{specialPGEnvironmentVars}->{PRINT_FILE_NAMES_FOR}  = [ $value ];\n";
} else {
	print $fh "#\$pg{specialPGEnvironmentVars}->{PRINT_FILE_NAMES_FOR}  = [  ];\n";
}

close $fh;
print "done.\n";

=head1 AUTHOR

Written by Sam Hathaway, hathaway at users.sourceforge.net.

=cut
